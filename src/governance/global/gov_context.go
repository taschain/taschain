package global

import (
	"governance/contract"
	"governance/vote"
	"governance/param"
	"core"
	"common"
	"governance/util"
	"vm/crypto"
)

/*
**  Creator: pxf
**  Date: 2018/4/19 上午9:56
**  Description: 
*/


const (
	CREDIT_ABI = `[{"constant":false,"inputs":[{"name":"ac","type":"address"},{"name":"delta","type":"uint32"}],"name":"addVoteAcceptCnt","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"ac","type":"address"},{"name":"delta","type":"uint32"}],"name":"addVoteCnt","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"ac","type":"address"},{"name":"v","type":"uint64"}],"name":"setLatestTransBlock","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"ac","type":"address"}],"name":"score","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"ac","type":"address"},{"name":"bound","type":"uint256"}],"name":"checkPermit","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"ac","type":"address"},{"name":"delta","type":"uint32"}],"name":"addTransCnt","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"ac","type":"address"}],"name":"creditInfo","outputs":[{"name":"transCnt","type":"uint32"},{"name":"latestTransBlock","type":"uint64"},{"name":"voteCnt","type":"uint32"},{"name":"voteAcceptCnt","type":"uint32"},{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"ac","type":"address"}],"name":"balance","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"credits","outputs":[{"name":"transCnt","type":"uint32"},{"name":"latestTransBlock","type":"uint64"},{"name":"voteCnt","type":"uint32"},{"name":"voteAcceptCnt","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"}]`
	CREDIT_CODE = `6060604052341561000f57600080fd5b6109368061001e6000396000f300606060405260043610610099576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063234907681461009e5780635f839d52146100e657806374a1ed731461012e578063776f38431461017a578063985ac176146101c7578063bade10c114610221578063d5b09cb714610269578063e3d670d71461030a578063fe5ff46814610357575b600080fd5b34156100a957600080fd5b6100e4600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803563ffffffff169060200190919050506103f1565b005b34156100f157600080fd5b61012c600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803563ffffffff1690602001909190505061046a565b005b341561013957600080fd5b610178600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803567ffffffffffffffff169060200190919050506104e3565b005b341561018557600080fd5b6101b1600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061054f565b6040518082815260200191505060405180910390f35b34156101d257600080fd5b610207600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610652565b604051808215151515815260200191505060405180910390f35b341561022c57600080fd5b610267600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803563ffffffff1690602001909190505061067d565b005b341561027457600080fd5b6102a0600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506106f6565b604051808663ffffffff1663ffffffff1681526020018567ffffffffffffffff1667ffffffffffffffff1681526020018463ffffffff1663ffffffff1681526020018363ffffffff1663ffffffff1681526020018281526020019550505050505060405180910390f35b341561031557600080fd5b610341600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610875565b6040518082815260200191505060405180910390f35b341561036257600080fd5b61038e600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610896565b604051808563ffffffff1663ffffffff1681526020018467ffffffffffffffff1667ffffffffffffffff1681526020018363ffffffff1663ffffffff1681526020018263ffffffff1663ffffffff16815260200194505050505060405180910390f35b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160108282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055505050565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600c8282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055505050565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160046101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055505050565b60008060008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002091506127108260000160009054906101000a900463ffffffff1663ffffffff168360000160049054906101000a900467ffffffffffffffff1667ffffffffffffffff164303028115156105e157fe5b048473ffffffffffffffffffffffffffffffffffffffff163160058460000160109054906101000a900463ffffffff160284600001600c9054906101000a900463ffffffff168560000160009054906101000a900463ffffffff16010163ffffffff16010390508092505050919050565b60008061065e8461054f565b9050828111156106715760019150610676565b600091505b5092915050565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055505050565b60008060008060008060008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900463ffffffff1694506000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160049054906101000a900467ffffffffffffffff1693506000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600c9054906101000a900463ffffffff1692506000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160109054906101000a900463ffffffff1691508573ffffffffffffffffffffffffffffffffffffffff1631905091939590929450565b60008173ffffffffffffffffffffffffffffffffffffffff16319050919050565b60006020528060005260406000206000915090508060000160009054906101000a900463ffffffff16908060000160049054906101000a900467ffffffffffffffff169080600001600c9054906101000a900463ffffffff16908060000160109054906101000a900463ffffffff169050845600a165627a7a723058202972d402109c4b78b6e73f0072b5941751706d7e621e106434a8d2e2f5a8fd360029`
	TEMPLATE_ABI = `[{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"templates","outputs":[{"name":"code","type":"bytes"},{"name":"abi","type":"string"},{"name":"blockNum","type":"uint64"},{"name":"author","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"key","type":"address"}],"name":"template","outputs":[{"name":"code","type":"bytes"},{"name":"abi","type":"string"},{"name":"blockNum","type":"uint64"},{"name":"author","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"key","type":"address"},{"name":"code","type":"bytes"},{"name":"abi","type":"string"}],"name":"addTemplate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]`
	TEMPLATE_CODE = `6060604052341561000f57600080fd5b610b278061001e6000396000f300606060405260043610610057576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806320a99bd01461005c5780635e3573cc146101c8578063975f6f5214610334575b600080fd5b341561006757600080fd5b610093600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506103f3565b6040518080602001806020018567ffffffffffffffff1667ffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838103835287818151815260200191508051906020019080838360005b83811015610123578082015181840152602081019050610108565b50505050905090810190601f1680156101505780820380516001836020036101000a031916815260200191505b50838103825286818151815260200191508051906020019080838360005b8381101561018957808201518184015260208101905061016e565b50505050905090810190601f1680156101b65780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b34156101d357600080fd5b6101ff600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610587565b6040518080602001806020018567ffffffffffffffff1667ffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838103835287818151815260200191508051906020019080838360005b8381101561028f578082015181840152602081019050610274565b50505050905090810190601f1680156102bc5780820380516001836020036101000a031916815260200191505b50838103825286818151815260200191508051906020019080838360005b838110156102f55780820151818401526020810190506102da565b50505050905090810190601f1680156103225780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b341561033f57600080fd5b6103f1600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610815565b005b6000602052806000526040600020600091509050806000018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561049f5780601f106104745761010080835404028352916020019161049f565b820191906000526020600020905b81548152906001019060200180831161048257829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561053d5780601f106105125761010080835404028352916020019161053d565b820191906000526020600020905b81548152906001019060200180831161052057829003601f168201915b5050505050908060020160009054906101000a900467ffffffffffffffff16908060020160089054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905084565b61058f6109ae565b6105976109c2565b6000806000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561066f5780601f106106445761010080835404028352916020019161066f565b820191906000526020600020905b81548152906001019060200180831161065257829003601f168201915b505050505093506000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561074b5780601f106107205761010080835404028352916020019161074b565b820191906000526020600020905b81548152906001019060200180831161072e57829003601f168201915b505050505092506000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900467ffffffffffffffff1691506000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160089054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690509193509193565b816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001908051906020019061086a9291906109d6565b50806000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010190805190602001906108c0929190610a56565b50436000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550336000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160086101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050565b602060405190810160405280600081525090565b602060405190810160405280600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610a1757805160ff1916838001178555610a45565b82800160010185558215610a45579182015b82811115610a44578251825591602001919060010190610a29565b5b509050610a529190610ad6565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610a9757805160ff1916838001178555610ac5565b82800160010185558215610ac5579182015b82811115610ac4578251825591602001919060010190610aa9565b5b509050610ad29190610ad6565b5090565b610af891905b80821115610af4576000816000905550600101610adc565b5090565b905600a165627a7a723058200e59ec683f71dcd34113a1cf41ba95e364ff1b9878b2ddca68cec82c614fd0c00029`
	VOTE_ABI = `[{"constant":false,"inputs":[{"name":"approval","type":"bool"}],"name":"vote","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"pass","type":"bool"}],"name":"updateCredit","outputs":[],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"handleDeposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"checkResult","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"voters","outputs":[{"name":"voted","type":"bool"},{"name":"delegate","type":"address"},{"name":"approval","type":"bool"},{"name":"voteBlock","type":"uint64"},{"name":"deposit","type":"uint64"},{"name":"depositBlock","type":"uint64"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"who","type":"address"}],"name":"delegateTo","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"value","type":"uint64"}],"name":"addDeposit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"voterAddrList","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"ac","type":"address"}],"name":"voterInfo","outputs":[{"name":"addr","type":"address"},{"name":"voted","type":"bool"},{"name":"delegate","type":"address"},{"name":"asDelegates","type":"address[]"},{"name":"approval","type":"bool"},{"name":"voteBlock","type":"uint64"},{"name":"deposit","type":"uint64"},{"name":"depositBlock","type":"uint64"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"caddr","type":"address"},{"name":"dm","type":"uint64"},{"name":"tdm","type":"uint64"},{"name":"vcm","type":"uint64"},{"name":"adm","type":"uint64"},{"name":"avcm","type":"uint64"},{"name":"vdb","type":"uint64"},{"name":"cb","type":"uint64"},{"name":"eb","type":"uint64"},{"name":"dgb","type":"uint64"},{"name":"cvs","type":"uint64"},{"name":"cls","type":"uint64"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]`
	VOTE_CODE = `6060604052341561000f57600080fd5b6040516101808062001fae833981016040528080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919080519060200190919050508b600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506100ec6102c864010000000002611aa6176401000000009004565b15156100f457fe5b8a600260146101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555089600360006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555088600360086101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555087600360106101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555086600360186101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555085600460006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555084600460086101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555083600460106101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555082600460186101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555081600560006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555080600560086101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055505050505050505050505050506103ca565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663985ac17633600560089054906101000a900467ffffffffffffffff1667ffffffffffffffff166040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182815260200192505050602060405180830381600087803b15156103ae57600080fd5b5af115156103bb57600080fd5b50505060405180519050905090565b611bd480620003da6000396000f300606060405260043610610099576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680634b9f5c981461009e57806359bbd5d7146100c35780638fe5c578146100e8578063a21d942f146100f2578063a3ec138d1461011f578063ac637c7a146101ff578063b0eba13214610238578063b36bef5714610265578063cdf58d35146102cf575b600080fd5b34156100a957600080fd5b6100c16004808035151590602001909190505061042a565b005b34156100ce57600080fd5b6100e6600480803515159060200190919050506105ae565b005b6100f061082f565b005b34156100fd57600080fd5b610105610b36565b604051808215151515815260200191505060405180910390f35b341561012a57600080fd5b610156600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610e81565b60405180871515151581526020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001851515151581526020018467ffffffffffffffff1667ffffffffffffffff1681526020018367ffffffffffffffff1667ffffffffffffffff1681526020018267ffffffffffffffff1667ffffffffffffffff168152602001965050505050505060405180910390f35b341561020a57600080fd5b610236600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610f33565b005b341561024357600080fd5b610263600480803567ffffffffffffffff16906020019091905050611155565b005b341561027057600080fd5b610278611401565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156102bb5780820151818401526020810190506102a0565b505050509050019250505060405180910390f35b34156102da57600080fd5b610306600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050611495565b604051808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001881515151581526020018773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001861515151581526020018567ffffffffffffffff1667ffffffffffffffff1681526020018467ffffffffffffffff1667ffffffffffffffff1681526020018367ffffffffffffffff1667ffffffffffffffff168152602001828103825287818151815260200191508051906020019060200280838360005b8381101561040f5780820151818401526020810190506103f4565b50505050905001995050505050505050505060405180910390f35b6000806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002091508160000160009054906101000a900460ff161580156104ae575060008260020160119054906101000a900467ffffffffffffffff1667ffffffffffffffff16115b80156104d95750600460009054906101000a900467ffffffffffffffff1667ffffffffffffffff1643105b801561051f575060008260000160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b801561052f575061052e61178c565b5b151561053757fe5b61054233844361188e565b600090505b81600101805490508110156105a95761059c826001018281548110151561056a57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff163361193a565b8080600101915050610547565b505050565b6000600460089054906101000a900467ffffffffffffffff1667ffffffffffffffff16431415156105db57fe5b600090505b60018054905081101561082b57600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16635f839d5260018381548110151561063a57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660016040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018263ffffffff16815260200192505050600060405180830381600087803b15156106f257600080fd5b5af115156106ff57600080fd5b505050811561081e57600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16632349076860018381548110151561075557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660016040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018263ffffffff16815260200192505050600060405180830381600087803b151561080d57600080fd5b5af1151561081a57600080fd5b5050505b80806001019150506105e0565b5050565b600080600080600080600460109054906101000a900467ffffffffffffffff1667ffffffffffffffff164314801561088757506000600260149054906101000a900467ffffffffffffffff1667ffffffffffffffff16115b151561088f57fe5b6000955060009450600093505b600180549050841015610997576000806001868154811015156108bb57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002092508260020160099054906101000a900467ffffffffffffffff1667ffffffffffffffff16860195508260020160009054906101000a900460ff16151561098a578260020160099054906101000a900467ffffffffffffffff1667ffffffffffffffff16850194505b838060010194505061089c565b859150600093505b600180549050841015610b2e576000806001868154811015156109be57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209250600090506001808054905003841415610a4157819050610a9d565b84868460020160099054906101000a900467ffffffffffffffff1667ffffffffffffffff16811515610a6f57fe5b04028360020160099054906101000a900467ffffffffffffffff160190508067ffffffffffffffff16820391505b600184815481101515610aac57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc8267ffffffffffffffff169081150290604051600060405180830381858888f193505050501515610b2157600080fd5b838060010194505061099f565b505050505050565b600080600080600080600080600460089054906101000a900467ffffffffffffffff1667ffffffffffffffff1643141515610b6d57fe5b6000600260149054906101000a900467ffffffffffffffff1667ffffffffffffffff161196508615610cbc57600180549050955060009450600093505b600180549050841015610c5e57600080600186815481101515610bc957fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002092508260020160009054906101000a900460ff1615610c515784806001019550505b8380600101945050610baa565b600360189054906101000a900467ffffffffffffffff1667ffffffffffffffff168567ffffffffffffffff1610158015610cb5575060016002600180549050811515610ca657fe5b04018567ffffffffffffffff16115b9750610e77565b6001805490509550600091506000905060009450600093505b600180549050841015610dd757600080600186815481101515610cf457fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002092508260020160099054906101000a900467ffffffffffffffff1667ffffffffffffffff16820191508260020160009054906101000a900460ff1615610dca5784806001019550508260020160099054906101000a900467ffffffffffffffff1667ffffffffffffffff16810190505b8380600101945050610cd5565b600360189054906101000a900467ffffffffffffffff1667ffffffffffffffff168567ffffffffffffffff1610158015610e2e575060016002600180549050811515610e1f57fe5b04018567ffffffffffffffff16115b8015610e5a5750600360109054906101000a900467ffffffffffffffff1667ffffffffffffffff168110155b8015610e7457506001600283811515610e6f57fe5b040181115b97505b5050505050505090565b60006020528060005260406000206000915090508060000160009054906101000a900460ff16908060000160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020160009054906101000a900460ff16908060020160019054906101000a900467ffffffffffffffff16908060020160099054906101000a900467ffffffffffffffff16908060020160119054906101000a900467ffffffffffffffff16905086565b60008060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060000160009054906101000a900460ff16158015610fab575060008273ffffffffffffffffffffffffffffffffffffffff1614155b8015610ff1575060008160000160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b801561101f575060008160020160119054906101000a900467ffffffffffffffff1667ffffffffffffffff16115b801561104a5750600460009054906101000a900467ffffffffffffffff1667ffffffffffffffff1643105b801561105a575061105961178c565b5b151561106257fe5b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010180548060010182816110b59190611a41565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050818160000160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611151338361193a565b5050565b6000806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002091508160000160009054906101000a900460ff161580156111d9575060008260020160119054906101000a900467ffffffffffffffff1667ffffffffffffffff16145b801561127c57506000600260149054906101000a900467ffffffffffffffff1667ffffffffffffffff1614801561121a575060008367ffffffffffffffff16145b8061127b57506000600260149054906101000a900467ffffffffffffffff1667ffffffffffffffff1611801561127a5750600260149054906101000a900467ffffffffffffffff1667ffffffffffffffff168367ffffffffffffffff1610155b5b5b80156112c05750600460189054906101000a900467ffffffffffffffff16600460009054906101000a900467ffffffffffffffff160367ffffffffffffffff164311155b80156112d057506112cf61178c565b5b15156112d857fe5b828260020160098282829054906101000a900467ffffffffffffffff160192506101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550438260020160116101000a81548167ffffffffffffffff021916908367ffffffffffffffff1602179055506001805480600101828161135b9190611a41565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550508160000160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905060008173ffffffffffffffffffffffffffffffffffffffff161415156113fc576113fb338261193a565b5b505050565b611409611a6d565b600180548060200260200160405190810160405280929190818152602001828054801561148b57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311611441575b5050505050905090565b60008060006114a2611a6d565b6000806000808897506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900460ff1696506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1695506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010180548060200260200160405190810160405280929190818152602001828054801561162157602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116115d7575b505050505094506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff1693506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160019054906101000a900467ffffffffffffffff1692506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160099054906101000a900467ffffffffffffffff1691506000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160119054906101000a900467ffffffffffffffff169050919395975091939597565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663985ac17633600560009054906101000a900467ffffffffffffffff1667ffffffffffffffff166040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182815260200192505050602060405180830381600087803b151561187257600080fd5b5af1151561187f57600080fd5b50505060405180519050905090565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905060018160000160006101000a81548160ff021916908315150217905550828160020160006101000a81548160ff021916908315150217905550818160020160016101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555050505050565b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900460ff1615611a3d57611a3c826000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff166000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160019054906101000a900467ffffffffffffffff1661188e565b5b5050565b815481835581811511611a6857818360005260206000209182019101611a679190611a81565b5b505050565b602060405190810160405280600081525090565b611aa391905b80821115611a9f576000816000905550600101611a87565b5090565b90565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663985ac17633600560089054906101000a900467ffffffffffffffff1667ffffffffffffffff166040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182815260200192505050602060405180830381600087803b1515611b8c57600080fd5b5af11515611b9957600080fd5b505050604051805190509050905600a165627a7a7230582077f331d673a078e07ecbb7f109ee655ac42ac04ec4fd0b78c8fd3c80b980d9c30029`
	DEPLOY_ACCOUNT = `_tas_gov_contract_admin_`
	VOTE_SCORE_MIN = 10
	LAUNCH_VOTE_SCORE_MIN = 100
	VOTER_CNT_MIN = 5
	APPROVAL_VOTER_MIN = 3
)

type GOV struct {
	CreditContract *contract.BoundContract
	CodeContract   *contract.BoundContract
	VoteContract   *contract.BoundContract
	VotePool       *vote.VotePool
	BlockChain     *core.BlockChain
	ParamManager   *param.ParamManager
	VoteScoreMin	uint64	//能投票的最低分数
	LaunchVoteScoreMin	uint64	//能发起投票的最低分数
	VoterCntMin		uint64	//最低参与投票人数
	ApprovalVoterMin	uint64	//投票通过的最低人数

	init           bool
}

var gov *GOV

func newGOV(creditAddr common.Address, codeAddr common.Address, bc *core.BlockChain) (*GOV) {
	return &GOV{
		CreditContract: contract.BuildBoundContract(creditAddr, CREDIT_ABI),
		CodeContract:   contract.BuildBoundContract(codeAddr, TEMPLATE_ABI),
		VoteContract:   contract.BuildBoundContract(common.Address{}, VOTE_ABI),
		VotePool:       vote.NewVotePool(),
		ParamManager:   param.NewParamManager(bc),
		BlockChain:     bc,
		VoteScoreMin: VOTE_SCORE_MIN,
		LaunchVoteScoreMin: LAUNCH_VOTE_SCORE_MIN,
		VoterCntMin: VOTER_CNT_MIN,
		ApprovalVoterMin: APPROVAL_VOTER_MIN,
		init:           true,
	}
}

func Gov() *GOV {
	if !gov.init {
		panic("gov module not init!")
	}
	return gov
}

func (g *GOV) NewVoteInst(ctx *contract.CallContext, address common.Address) *contract.Vote {
	return contract.NewVote(ctx, address, g.VoteContract)
}

func (g *GOV) NewTasCreditInst(ctx *contract.CallContext) *contract.TasCredit {
	return contract.NewTasCredit(ctx, g.CreditContract)
}

func (g *GOV) NewTemplateCodeInst(ctx *contract.CallContext) *contract.TemplateCode {
	return contract.NewTemplateCode(ctx, g.CodeContract)
}

func InitGov(bc *core.BlockChain) bool {
	if gov.init {
		return true
	}
	creditAddr := crypto.CreateAddress(util.ToETHAddress(common.StringToAddress(DEPLOY_ACCOUNT)), 0)
	codeAddr := crypto.CreateAddress(util.ToETHAddress(common.StringToAddress(DEPLOY_ACCOUNT)), 1)
	gov = newGOV(util.ToTASAddress(creditAddr), util.ToTASAddress(codeAddr), bc)
	return true
}