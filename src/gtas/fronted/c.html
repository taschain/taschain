<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./js/layui/css/layui.css">
    <style type="text/css">
        .wallet_tr {word-wrap:break-word; word-break:break-all;}
    </style>
</head>
<body>
<div class="layui-tab" lay-filter="demo" style="margin: 50px 5%"  >
    <ul class="layui-tab-title">
        <li class="layui-this">Dashboard</li>
        <li>新建账户</li>
        <li>转账演示</li>
        <li>查询余额</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item  layui-show">
            <div class="layui-row layui-col-space10 layui-bg-green">
                <div class="layui-col-md5">
                </div>
                <div class="layui-col-md3" style="font-size: 20px">
                    <span>当前块高：</span><span id="block_height">0</span>
                </div>
                <div class="layui-col-md4">
                </div>
            </div>
            <hr/>
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md6">
                    <label>已连接节点</label>
                    <table class="layui-table">
                        <colgroup>
                            <col width="50%">
                            <col width="30%">
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th>id</th>
                            <th>ip地址</th>
                            <th>端口</th>
                        </tr>
                        </thead>
                        <tbody id="nodes_table">

                        </tbody>
                    </table>
                </div>
                <div class="layui-col-md6">
                    <label>缓冲区</label>
                    <table class="layui-table">
                        <colgroup>
                            <col width="33%">
                            <col width="33%">
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th>source</th>
                            <th>target</th>
                            <th>value</th>
                        </tr>
                        </thead>
                        <tbody id="trans_table">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-tab-item">
            <button class="layui-btn" id="create_btn">创建账户</button>
            <table class="layui-table" style="table-layout: fixed">
                <colgroup>
                    <col width="65%">
                    <col width="20%">
                    <col>
                </colgroup>
                <thead>
                <tr>
                    <th>私钥</th>
                    <th>钱包地址</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="create_chart">

                </tbody>
            </table>
        </div>
        <div class="layui-tab-item">
            <form class="layui-form" action="">
                <div class="layui-form-item">
                    <label class="layui-form-label">from</label>
                    <div class="layui-input-block">
                        <input type="text" name="from"   autocomplete="off" class="layui-input"
                               placeholder="请输入发送方地址(len=40)">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">to</label>
                    <div class="layui-input-block">
                        <input type="text" name="to"   autocomplete="off" class="layui-input"
                               placeholder="请输入接收方地址(len=40)">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">amount</label>
                    <div class="layui-input-block">
                        <input type="text" name="amount"  autocomplete="off" class="layui-input"
                               placeholder="请输入金额(正整数)">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">code</label>
                    <div class="layui-input-block">
                        <input type="text" name="code"  autocomplete="off" class="layui-input"
                               placeholder="code">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="t_form">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
            <hr/>
            Message: &nbsp;<span id="t_message"></span>
            <hr/>
            Error: &nbsp; <span id="t_error"></span>
            <hr/>
        </div>

        <div class="layui-tab-item">

            <table class="layui-table">
                <colgroup>
                    <col width="50%">
                    <col width="30%">
                </colgroup>
                <thead>
                <tr>
                    <th>地址</th>
                    <th>余额</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="balance_chart">
                    <tr>
                        <td>
                            <input type="text" name="account"   autocomplete="off" class="layui-input"
                                   placeholder="请输入查询地址" id="query_input_0">
                        </td>
                        <td id="query_balance_0">

                        </td>
                        <td>
                            <button class="layui-btn query_btn"  id="query_btn_0">查询</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="text" name="account"   autocomplete="off" class="layui-input"
                                   placeholder="请输入查询地址" id="query_input_1">
                        </td>
                        <td id="query_balance_1">

                        </td>
                        <td>
                            <button class="layui-btn query_btn"  id="query_btn_1">查询</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="text" name="account"   autocomplete="off" class="layui-input"
                                   placeholder="请输入查询地址" id="query_input_2">
                        </td>
                        <td id="query_balance_2">

                        </td>
                        <td>
                            <button class="layui-btn query_btn" id="query_btn_2">查询</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="text" name="account"   autocomplete="off" class="layui-input"
                                   placeholder="请输入查询地址" id="query_input_3">
                        </td>
                        <td id="query_balance_3">

                        </td>
                        <td>
                            <button class="layui-btn query_btn" id="query_btn_3">查询</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="text" name="account"   autocomplete="off" class="layui-input"
                                   placeholder="请输入查询地址" id="query_input_4">
                        </td>
                        <td id="query_balance_4">

                        </td>
                        <td>
                            <button class="layui-btn query_btn" id="query_btn_4">查询</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div style="padding-top: 30px"></div>
            <hr/>
            Message: &nbsp;<span id="balance_message"></span>
            <hr/>
            Error: &nbsp; <span id="balance_error"></span>
            <hr/>
        </div>
    </div>
</div>
<script src="./js/layui/layui.js"></script>
<script>

    layui.use(['form', 'jquery', 'element'], function(){
        var element = layui.element;
        var form = layui.form;
        var $ = layui.$;
        var HOST = "http://127.0.0.1:8080";
        var ref;
        var ref2;

        // 查询余额
        $(".query_btn").click(function () {
            let id = $(this).attr("id");
            let count = id.split("_")[2];
            $("#balance_message").text("");
            $("#balance_error").text("");
            let params = {
                "method": "GTAS_balance",
                "params": [$("#query_input_"+count).val()],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        $("#balance_message").text(rdata.result.message);
                        $("#query_balance_"+count).text(rdata.result.data)
                    }
                    if (rdata.error !== undefined){
                        $("#balance_error").text(rdata.error.message);
                    }
                },
            });
        });

        // 钱包初始化
        function init_wallets() {
            let params = {
                "method": "GTAS_getWallets",
                "params": [],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        $.each(rdata.result.data, function (i,val) {
                            let tr = "<tr class='wallet_tr'><td>" + val.private_key + "</td><td>" + val.address
                                    + '</td><td ><button class="layui-btn wallet_del">删除</button></td></tr>';
                            $("#create_chart").append(tr);

                            $(".wallet_del").click(function () {
                                let parent = $(this).parents("tr");
                                del_wallet(parent.children("td:eq(1)").text());
                                parent.remove();
                            });
                        })
                    }
                },
            });
        }

        function del_wallet(key) {
            let params = {
                "method": "GTAS_deleteWallet",
                "params": [key],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {

                },
            });
        }

        init_wallets();


        // 创建钱包
        $("#create_btn").click(function () {
            let params = {
                "method": "GTAS_newWallet",
                "params": [],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    let tr = "<tr class='wallet_tr'><td>" + rdata.result.data.private_key + "</td><td>" + rdata.result.data.address
                            + '</td><td ><button class="layui-btn wallet_del">删除</button></td></tr>';
                    $("#create_chart").append(tr);

                    $(".wallet_del").click(function () {
                        let parent = $(this).parents("tr");
                        del_wallet(parent.children("td:eq(1)").text());
                        parent.remove();
                    });
                },
            });
        });


        // 交易表单提交
        form.on('submit(t_form)', function(data){
            $("#t_message").text("");
            $("#t_error").text("");
            let from = data.field.from;
            let to = data.field.to;
            let amount = data.field.amount;
            let code = data.field.code;
            if (from.length !== 42) {
                layer.msg("from 参数字段长度错误");
                return false
            }
            if (to.length !== 42) {
                layer.msg("to 参数字段长度错误");
                return false
            }
            let params = {
                "method": "GTAS_t",
                "params": [from, to, parseFloat(amount), code],
                "jsonrpc": "2.0",
                "id": "1"
            };

            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        $("#t_message").text(rdata.result.message)
                    }
                    if (rdata.error !== undefined){
                        $("#t_error").text(rdata.error.message)
                    }
                },
            });
            return false;
        });

        // 同步已链接节点
        function syncNodes() {
            let params = {
                "method": "GTAS_connectedNodes",
                "params": [],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        let nodes_table = $("#nodes_table");
                        nodes_table.empty();
                        $.each(rdata.result.data, function (i,val) {
                            nodes_table.append(
                                    " <tr><td>id</td><td>ip</td><td>port</td></tr>".replace("ip", val.ip).replace("id", val.id).replace("port", val.tcp_port)
                            )
                        })
                    }
                    if (rdata.error !== undefined){
                        // $("#t_error").text(rdata.error.message)
                    }
                },
            });
        }

        // 同步缓冲区交易
        function syncTrans() {
            let params = {
                "method": "GTAS_transPool",
                "params": [],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        let trans_table = $("#trans_table");
                        trans_table.empty();
                        rdata.result.data.sort(function (a, b) {
                            return parseInt(b.value) - parseInt(a.value)
                        });
                        $.each(rdata.result.data, function (i,val) {
                            trans_table.append(
                                    " <tr><td>source</td><td>target</td><td>value</td></tr>"
                                            .replace("value", val.value)
                                            .replace("source",  val.source.slice(0, 7) + "..." + val.source.slice(-6))
                                            .replace("target",  val.target.slice(0, 7) + "..." + val.target.slice(-6))
                            )
                        })
                    }
                    if (rdata.error !== undefined){
                        // $("#t_error").text(rdata.error.message)
                    }
                },
            });
        }

        // 同步块高
        function syncBlockHeight() {
            let params = {
                "method": "GTAS_blockHeight",
                "params": [],
                "jsonrpc": "2.0",
                "id": "1"
            };
            $.ajax({
                type: 'POST',
                url: HOST,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Type", "application/json");
                },
                data: JSON.stringify(params),
                success: function (rdata) {
                    if (rdata.result !== undefined){
                        let block_height = $("#block_height");
                        block_height.text(rdata.result.data)
                    }
                    if (rdata.error !== undefined){
                        // $("#t_error").text(rdata.error.message)
                    }
                },
            });
        }


        // dashboard同步数据
        syncNodes();
        syncTrans();
        syncBlockHeight();
        ref = setInterval(function(){
            syncNodes();
            syncTrans();
            syncBlockHeight();
        },1000);

        element.on('tab(demo)', function(data){
            if(data.index === 0) {
                syncNodes();
                ref = setInterval(function(){
                    syncNodes();
                    syncTrans();
                    syncBlockHeight();
                },1000);
            } else {
                clearInterval(ref)
            }
        });

    });
</script>

</body>
</html>